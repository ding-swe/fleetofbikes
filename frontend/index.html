<!DOCTYPE html>
<html lang="en">
  	<head>
	    <title>Fleet of Bikes</title>
	    <meta charset="utf-8">
    	
		<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7/leaflet.css"/>
    	<style>
		      #mapid {
		        height: 100%;
		        width: 100%;
		      }

		      #update_toggle{
		      	background: green;
		      }

		      #error_log{
		      	background: #33A7FF;
		      }
			
		    /* Optional: Makes the sample page fill the window. */ 
		    html, body {
		    	height: 100%;
		        margin: 0;
		        padding: 0;
		    }
   		</style>
   		<!-- Bootstrap Core CSS -->
   		<link href="css/bootstrap.min.css" rel="stylesheet">
	    <!-- Custom CSS -->
	    <link href="css/simple-sidebar.css" rel="stylesheet">
	   
	    <!-- jQuery -->
		<script src="js/jquery.js"></script>
		<!-- Bootstrap Core JavaScript -->
		<script src="js/bootstrap.min.js"></script>
			  	<!-- Make sure you put this AFTER Leaflet's CSS -->
	 	<script src="https://unpkg.com/leaflet@1.4.0/dist/leaflet.js"></script>
 	 </head>
  
  	<body>
  		
  		<div id="wrapper">
	        <!-- Sidebar -->
	        <div id="sidebar-wrapper">
	            <ul class= "sidebar-nav">
	                <li class="sidebar-brand">
	                        <img id=menu src="menu.png" alt="menu" style="z-index:10; width: 10%; text-align:left;">  
	                </li>
					<li>
						<table style="width: 100%;"><row>
							<td  style = "width:30%;"><a href="#">Search</a></td>
							<td style = "width:70%; text-align: left;"> <input id = "input" type="Search" name="fname" style = "height: 30px; width: 150px">
							</td></row>
						</table>
					</li>
					<li>
						<a href="#">Filter</a>
					</li>
					<li>
						<a href="#">Overview</a>
					</li>
					<li class = "update_toggle" id = "update_toggle">
						<a href="#">Start Running</a>
					</li>
					<li class = "error_log" id = "error_log" >
						<a href="#">Error log OK</a>
					</li>
				</ul>
	        </div>
	        <!-- /#sidebar-wrapper -->
	        <!-- Page Content -->
			<!-- /#page-content-wrapper -->
		</div>

		<div id="mapid"></div>
	 	
    	<script>
    			var bikes = {};
    			var updating_locations = false; 
    			var all_locs; 

    			/* scrapped bounds code
    			var southWest = L.latLng(38.960324, -76.977949),
				northEast = L.latLng(39.011634, -76.893137),
				bounds = L.latLngBounds(southWest, northEast); , {maxBounds:bounds}*/

    			// configuring LeafletJS map
		    	var map = L.map('mapid').setView([38.992103, -76.937625], 18);

		        L.tileLayer('https://api.mapbox.com/styles/v1/ebding/cjv333g3y7s2z1fmz1yrwmhiw/tiles/256/{z}/{x}/{y}@2x?access_token={accessToken}', {
				    attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
				    maxZoom: 18,
				    minZoom: 14,
				    accessToken: 'pk.eyJ1IjoiZWJkaW5nIiwiYSI6ImNqdjJ5dm5rbTJhMWU0ZXNkZG9jbjRxYnMifQ.ZjX-s9GZcPhjCzW6rUNCqg'
				}).addTo(map);

				var icon = L.icon({
				    iconUrl: 'marker-icon.png',
				    shadowUrl: 'marker-icon.png',
				    iconSize:     [15, 15], // size of the icon
				    shadowSize:   [0, 0], // size of the shadow
				});
				

				// begin the map updates 
				var j = 0; 
				loop();

				function sleep(ms) {
	 				return new Promise(resolve => setTimeout(resolve, ms));
				}

				async function loop() {
					while(true){					
			   			if(updating_locations){
			   					all_locs = $.ajax({
										    url: "http://fleetofbikes-env.vrqy7xh9wt.us-east-1.elasticbeanstalk.com/bike/location/current/all",
										    async: false,
										    dataType: 'json',

										    success: function(data, status, xhr){
										    		$('.error_log a').html("Error log OK")	
													$('.error_log a').css('background', "#33A7FF")
										    },

										    error: function(xhr, status,error){
										    		console.log("problem")
								   					$('.error_log a').html("responseJSON not received from server")	
													$('.error_log a').css('background', "red")
										    }
										}).responseJSON

			   				

			   				

			   				for(i = 0; i < all_locs.length; i++){
			   					bike = all_locs[i]
			   					if(bikes[bike.name] == undefined){
			   						bikes[bike.name] = new L.Marker([bike.lat, bike.lon], {icon : icon}).addTo(map);
			   					} else{	// defined, update current marker position 
			   						bikes[bike.name].setLatLng([bike.lat, bike.lon]).update(); 
			   					}
			   				}

			   				j = j + 1;
			   				console.log(j + "th iteration")
			   			}
			   			await sleep(2500) 
			   		}
				} 
    	</script>
  
  		<!-- Menu Toggle Script "#menu-toggle" -->
		<script>
			$(".sidebar-brand").click(function(e) {
				e.preventDefault();
				$("#wrapper").toggleClass("toggled");
				$(".sidebar-brand").toggleClass("toggled");
			});

			$(".update_toggle").click(function(e) {
				if(updating_locations){
					updating_locations = false;
					$('.update_toggle a').html("Press to START UPDATING")
					$('.update_toggle a').css('background', "green")
				}
				else{
					updating_locations = true; 
					$('.update_toggle a').html("Press to STOP UPDATING")	
					$('.update_toggle a').css('background', "red")
				}
			});
					
			document.getElementById("input").addEventListener("keydown", function(e) {
				if (!e) { var e = window.event; }
				if (e.keyCode == 13) {alert(document.getElementById("input").value); }
			}, false) 
		</script>
  	</body>
</html>